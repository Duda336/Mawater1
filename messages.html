<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Mawater974</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gray-800 shadow-lg" id="navbar"></nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden">
            <div class="grid grid-cols-12 min-h-[600px]">
                <!-- Conversations List -->
                <div class="col-span-4 border-r border-gray-700">
                    <div class="p-4 border-b border-gray-700">
                        <h2 class="text-xl font-bold">Messages</h2>
                    </div>
                    <div id="conversationsList" class="overflow-y-auto h-[calc(600px-4rem)]">
                        <!-- Loading placeholder -->
                        <div class="text-center py-8">
                            <p class="text-gray-400">Loading conversations...</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="col-span-8 flex flex-col">
                    <!-- Default State -->
                    <div id="defaultState" class="flex-1 flex items-center justify-center">
                        <div class="text-center">
                            <i class="far fa-comments text-6xl text-gray-600 mb-4"></i>
                            <h2 class="text-xl font-semibold mb-2">Select a Conversation</h2>
                            <p class="text-gray-400">Choose a conversation from the list to start chatting</p>
                        </div>
                    </div>

                    <!-- Active Chat -->
                    <div id="activeChat" class="hidden flex-1 flex flex-col">
                        <!-- Chat Header -->
                        <div class="p-4 border-b border-gray-700 flex items-center">
                            <div>
                                <h3 id="chatName" class="font-semibold"></h3>
                                <p id="chatCarInfo" class="text-sm text-gray-400"></p>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                            <!-- Messages will be inserted here -->
                        </div>

                        <!-- Message Input -->
                        <div class="p-4 border-t border-gray-700">
                            <form id="messageForm" class="flex space-x-4">
                                <input type="text" id="messageInput" 
                                       class="flex-1 bg-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-400"
                                       placeholder="Type your message...">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                    Send
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8" id="footer"></footer>

    <script>
        // Load navbar and footer
        fetch('navbar.html')
            .then(response => response.text())
            .then(html => document.getElementById('navbar').innerHTML = html);
        
        fetch('footer.html')
            .then(response => response.text())
            .then(html => document.getElementById('footer').innerHTML = html);

        // Check authentication
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) {
            window.location.href = 'login.html';
        }

        let activeConversationId = null;
        let messagePollingInterval = null;

        // Load conversations
        async function loadConversations() {
            try {
                const response = await fetch(`http://localhost:5000/api/messages?user_id=${user.id}`);
                const conversations = await response.json();

                const list = document.getElementById('conversationsList');

                if (!response.ok) {
                    list.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500">Error: ${conversations.error || 'Failed to load conversations'}</p>
                        </div>
                    `;
                    return;
                }

                if (conversations.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-400">No messages yet</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = conversations.map(conv => `
                    <div onclick="openConversation(${conv.other_user_id})" 
                         class="p-4 hover:bg-gray-700 cursor-pointer transition ${activeConversationId === conv.other_user_id ? 'bg-gray-700' : ''}">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-semibold">${conv.firstName} ${conv.lastName}</h3>
                            ${conv.unread_count > 0 ? `
                                <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">
                                    ${conv.unread_count}
                                </span>
                            ` : ''}
                        </div>
                        ${conv.car_make ? `
                            <p class="text-sm text-gray-400">
                                Re: ${conv.car_year} ${conv.car_make} ${conv.car_model}
                            </p>
                        ` : ''}
                        <p class="text-xs text-gray-500 mt-1">
                            ${new Date(conv.last_message_time).toLocaleString()}
                        </p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('conversationsList').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500">Error loading conversations. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Open conversation
        async function openConversation(conversationId) {
            activeConversationId = conversationId;
            document.getElementById('defaultState').classList.add('hidden');
            document.getElementById('activeChat').classList.remove('hidden');
            
            // Start polling for new messages
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
            }
            messagePollingInterval = setInterval(() => loadMessages(conversationId), 5000);
            
            await loadMessages(conversationId);
            loadConversations(); // Refresh conversation list
        }

        // Load messages
        async function loadMessages(conversationId) {
            try {
                const response = await fetch(`http://localhost:5000/api/messages/${conversationId}?user_id=${user.id}`);
                const messages = await response.json();

                const container = document.getElementById('messagesContainer');

                if (!response.ok) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500">Error: ${messages.error || 'Failed to load messages'}</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = messages.map(msg => `
                    <div class="flex ${msg.sender_id === user.id ? 'justify-end' : 'justify-start'}">
                        <div class="${msg.sender_id === user.id ? 
                            'bg-blue-600 text-white' : 
                            'bg-gray-700 text-gray-200'} 
                            rounded-lg px-4 py-2 max-w-[70%]">
                            <p>${msg.message}</p>
                            <p class="text-xs opacity-75 mt-1">
                                ${new Date(msg.created_at).toLocaleString()}
                            </p>
                        </div>
                    </div>
                `).join('');

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;

                // Update chat header
                if (messages.length > 0) {
                    const otherUser = messages[0].sender_id === user.id ? 
                        messages[0].receiver_name : 
                        messages[0].sender_name;
                    document.getElementById('chatName').textContent = otherUser;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('messagesContainer').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500">Error loading messages. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Send message
        document.getElementById('messageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!activeConversationId) return;

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            try {
                const response = await fetch(`http://localhost:5000/api/messages?user_id=${user.id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        receiver_id: activeConversationId,
                        message: message
                    })
                });

                if (response.ok) {
                    input.value = '';
                    await loadMessages(activeConversationId);
                    loadConversations(); // Refresh conversation list
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to send message');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending message');
            }
        });

        // Check for car_id in URL params (for starting new conversation)
        const urlParams = new URLSearchParams(window.location.search);
        const carId = urlParams.get('car_id');
        if (carId) {
            // Implement logic to start new conversation about specific car
        }

        // Load conversations when page loads
        window.addEventListener('load', loadConversations);

        // Cleanup on page unload
        window.addEventListener('unload', () => {
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
            }
        });
    </script>
</body>
</html>
