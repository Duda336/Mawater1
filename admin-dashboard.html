<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Mawater974</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gray-800 shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="text-xl font-bold">Mawater974 Admin</a>
                </div>
                <div class="flex items-center" id="userSection">
                    <!-- User info will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-6">Pending Car Listings</h2>
            <div id="pendingListings" class="space-y-6">
                <!-- Listings will be populated by JavaScript -->
                <div class="text-center py-8">
                    <p class="text-gray-400">Loading pending listings...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Check if user is admin
        document.addEventListener('DOMContentLoaded', function() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.is_admin) {
                window.location.href = 'index.html';
                return;
            }

            // Update user section
            document.getElementById('userSection').innerHTML = `
                <div class="flex items-center">
                    <span class="mr-4">${user.firstName} ${user.lastName}</span>
                    <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-full hover:bg-red-700 transition">
                        Logout
                    </button>
                </div>
            `;

            // Load pending listings
            loadPendingListings();
        });

        async function loadPendingListings() {
            const user = JSON.parse(localStorage.getItem('user'));
            try {
                const response = await fetch(`http://localhost:5000/api/admin/cars?user_id=${user.id}`);
                const cars = await response.json();

                const listingsContainer = document.getElementById('pendingListings');
                if (!response.ok) {
                    listingsContainer.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500">Error: ${cars.error || 'Failed to load listings'}</p>
                        </div>
                    `;
                    return;
                }

                if (cars.length === 0) {
                    listingsContainer.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-400">No pending listings at the moment.</p>
                        </div>
                    `;
                    return;
                }

                listingsContainer.innerHTML = cars.map(car => `
                    <div class="bg-gray-700 rounded-lg p-6" id="listing-${car.id}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-semibold">${car.year} ${car.make} ${car.model}</h3>
                                <p class="text-gray-400 mt-2">Listed by: ${car.user_name} (${car.user_email})</p>
                                <p class="text-gray-400">Price: â‚¬${Number(car.price).toLocaleString()}</p>
                                <p class="text-gray-400">Mileage: ${Number(car.mileage).toLocaleString()} km</p>
                                <p class="text-gray-400">Condition: ${car.condition}</p>
                                <p class="text-gray-400 mt-4">${car.description}</p>
                            </div>
                            <div class="flex space-x-4">
                                <button onclick="updateCarStatus(${car.id}, 'approved')"
                                        class="bg-green-600 text-white px-4 py-2 rounded-full hover:bg-green-700 transition">
                                    Approve
                                </button>
                                <button onclick="updateCarStatus(${car.id}, 'rejected')"
                                        class="bg-red-600 text-white px-4 py-2 rounded-full hover:bg-red-700 transition">
                                    Reject
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('pendingListings').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-500">Error loading listings. Please try again later.</p>
                    </div>
                `;
            }
        }

        async function updateCarStatus(carId, status) {
            const user = JSON.parse(localStorage.getItem('user'));
            try {
                const response = await fetch(`http://localhost:5000/api/admin/cars/${carId}?user_id=${user.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                const data = await response.json();
                if (response.ok) {
                    // Remove the listing from the UI
                    document.getElementById(`listing-${carId}`).remove();
                    
                    // Check if there are no more listings
                    if (document.getElementById('pendingListings').children.length === 0) {
                        document.getElementById('pendingListings').innerHTML = `
                            <div class="text-center py-8">
                                <p class="text-gray-400">No pending listings at the moment.</p>
                            </div>
                        `;
                    }
                } else {
                    alert(data.error || 'Failed to update listing status');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating listing status');
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
